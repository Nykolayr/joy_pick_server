# Концепция заявок (Requests Concept)

## Статусы заявок

### Основные статусы

1. **`new`** - создана
   - Заявка только что создана пользователем
   - Ожидает публикации или начала работы

2. **`inProgress`** - в процессе выполнения
   - Для **waste**: когда человек присоединился к заявке
   - Для **event**: устанавливается сразу при создании (создатель уже является участником)
   - Для **speed**: когда человек перешел на страницу выполнения

3. **`pending`** - ожидает рассмотрения
   - После того как заявку заполнили полностью, она передается на рассмотрение модератору
   - Модератор должен одобрить или отклонить заявку

4. **`approved`** - одобрена
   - Заявка прошла модерацию и одобрена
   - Могут быть выполнены действия по начислению коинов и распределению средств

5. **`rejected`** - отклонена
   - Заявка отклонена модератором
   - Может содержать кастомное сообщение от модератора
   - Деньги возвращаются пользователям

6. **`completed`** - завершена
   - Заявка успешно выполнена
   - Все начисления и выплаты произведены

---

## Логика по типам заявок

### Waste Location (waste)

#### Жизненный цикл заявки

1. **Создание и публикация**
   - Пользователь создает заявку
   - Статус: `new`
   - Заявка публикуется и становится доступной для просмотра

2. **Донаты**
   - Несколько человек могут задонатить, нажав на кнопку доната
   - Донаты накапливаются в заявке
   - Донатеры сохраняются в списке `donations`

3. **Присоединение исполнителя**
   - Один человек может присоединиться к заявке
   - Как только он присоединяется, статус меняется на `inProgress`
   - Сохраняется `joined_user_id` и `join_date`

4. **Выполнение заявки**
   - Исполнитель выполняет работу
   - Если в течение **24 часов** (суток) исполнитель не закончил заявку и не отправил на рассмотрение:
     - Статус заявки снова становится `new`
     - Заявка снова доступна для присоединения
     - `joined_user_id` и `join_date` обнуляются

5. **Автоматическое удаление**
   - **TODO: После проверки вернуть на 7 дней (сейчас 1 день для тестирования)**
   - Если в течение **1 дня** (для проверки, потом вернуть на 7 дней) к заявке никто не присоединился:
     - Создателю отправляется push-уведомление: "Your request will be deleted in 24 hours. You can extend it for another week by opening the request."
     - Создатель может продлить заявку еще на неделю через endpoint `POST /api/requests/:id/extend` (максимум одно продление)
     - Если заявка не была продлена, через **2 дня** (1 день + 1 день ожидания, для проверки, потом вернуть на 8 дней):
       - Заявка удаляется из БД
       - Пользователю уходит пуш-уведомление: "Your request was deleted due to inactivity"
       - Донатерам уходит пуш-уведомление: "Request you donated to was deleted"
       - Донатерам и создателю (если он делал платную заявку) возвращаются деньги
     - **Это выполняется на бэкенде**

6. **Отправка на модерацию**
   - Исполнитель отправляет заявку на рассмотрение
   - Статус меняется на `pending`
   - Заявка передается модератору

7. **Одобрение заявки**
   - Модератор одобряет заявку
   - Статус меняется на `approved`
   - **На бэкенде:**
     - Создателю начисляется 1 коин
     - Исполнителю начисляется 1 коин
     - Донатерам начисляется по 1 коину каждому
     - Отправляются пуш-уведомления:
       - Донатерам: благодарность за донат (на английском)
       - Исполнителю: благодарность за исполнение (на английском)
       - Создателю: благодарность за инициативу (на английском)
     - Все деньги, которые вложил заказчик и донатеры, за вычетом комиссии, уходят исполнителю
   - Статус меняется на `completed`

8. **Отклонение заявки**
   - Модератор отклоняет заявку
   - Статус меняется на `rejected`
   - **На бэкенде:**
     - Возвращаются все деньги (создателю и донатерам)
     - Отправляются пуш-уведомления с сообщением:
       - Либо стандартным сообщением
       - Либо кастомным сообщением, которое написал модератор на странице модерации

#### Поля для модерации

При отклонении заявки модератор должен иметь возможность:
- Выбрать стандартное сообщение об отклонении
- Или написать свое кастомное сообщение в поле `rejection_reason` (или `rejection_message`)

#### Пуш-уведомления для Waste

**Важно:** Все пуш-уведомления должны переходить на соответствующую заявку при нажатии.

1. **При присоединении исполнителя**
   - Когда кто-то присоединился к заявке (`joined_user_id` заполнен)
   - Отправить пуш-уведомление создателю (`created_by`)
   - Сообщение: "Someone joined your request!" (на английском)
   - Пуш должен открывать страницу заявки

2. **При отправке на рассмотрение**
   - Когда исполнитель отправил заявку на рассмотрение (статус меняется на `pending`)
   - Отправить пуш-уведомление создателю (`created_by`)
   - Сообщение: "Your request has been submitted for review!" (на английском)
   - Пуш должен открывать страницу заявки

3. **Напоминание исполнителю (за 2 часа до окончания суток)**
   - За 2 часа до окончания 24 часов с момента присоединения (`join_date + 22 часа = текущее время`)
   - Отправить пуш-уведомление исполнителю (`joined_user_id`)
   - Сообщение: "You have 2 hours left to complete the request!" (на английском)
   - Пуш должен открывать страницу заявки

4. **Если заявка не выполнена в срок**
   - Если прошло 24 часа с момента присоединения и заявка не отправлена на рассмотрение
   - Отправить пуш-уведомление исполнителю (`joined_user_id`)
   - Сообщение: "You didn't complete the request on time. Please try to be more responsible next time." (на английском, с легким осуждением)
   - Пуш должен открывать страницу заявки
   - Отправить пуш-уведомление создателю (`created_by`)
   - Сообщение: "The request was not completed on time and is now available for everyone again." (на английском)
   - Пуш должен открывать страницу заявки

5. **После модерации (одобрение)**
   - Создателю: "Thank you for your initiative!" (на английском)
   - Исполнителю: "Thank you for completing the request!" (на английском)
   - Донатерам: "Thank you for your donation!" (на английском)
   - Все пуши должны открывать страницу заявки

6. **После модерации (отклонение)**
   - Создателю: сообщение из `rejection_reason` или стандартное "Your request was rejected"
   - Донатерам: "Request you donated to was rejected: {сообщение}"
   - Все пуши должны открывать страницу заявки

---

## API изменения (для бэкенда)

### Новые статусы в API

Статусы заявок теперь включают:
- `new` - создана
- `inProgress` - в процессе выполнения
- `pending` - ожидает рассмотрения
- `approved` - одобрена
- `rejected` - отклонена
- `completed` - завершена

### Новые поля в модели Request

1. **`rejection_reason`** (string, опционально)
   - Причина отклонения заявки
   - Может быть стандартным сообщением или кастомным от модератора
   - Заполняется при отклонении заявки

2. **`rejection_message`** (string, опционально)
   - Кастомное сообщение от модератора при отклонении
   - Если заполнено, используется вместо стандартного сообщения

3. **`actual_participants`** (array[string], опционально)
   - Массив ID реальных участников события (только для event)
   - Заполняется заказчиком при закрытии события
   - Используется для начисления коинов только реальным участникам

4. **`expires_at`** (datetime, опционально)
   - Дата истечения заявки (только для wasteLocation)
   - **TODO: После проверки вернуть на 7 дней (сейчас 1 день для тестирования)**
   - Автоматически устанавливается при создании: `created_at + 1 день` (для проверки, потом вернуть на 7 дней)
   - При продлении заявки: `expires_at += 1 день` (для проверки, потом вернуть на 7 дней)
   - Используется для определения, когда заявка должна быть удалена

5. **`extended_count`** (integer, опционально)
   - Количество продлений заявки (только для wasteLocation)
   - По умолчанию: `0`
   - Максимум: `1` (одно продление)
   - Используется для ограничения количества продлений

### Новый endpoint для продления заявки

**POST** `/api/requests/:id/extend`

**Описание:**
**TODO: После проверки вернуть на 7 дней (сейчас 1 день для тестирования)**
Продление заявки типа `wasteLocation` еще на 1 день (для проверки, потом вернуть на неделю). Доступно только для заявок со статусом `new`, которые еще не истекли и не были продлены ранее.

**Ограничения:**
- Только для заявок типа `wasteLocation`
- Только для заявок со статусом `new`
- Только создатель заявки может продлить ее
- Максимум одно продление (`extended_count` не должен быть >= 1)
- Заявка не должна быть истекшей (`expires_at` > текущее время)

**Действия при продлении:**
- `expires_at` увеличивается на 1 день (для проверки, потом вернуть на 7 дней)
- `extended_count` устанавливается в `1`
- Возвращается обновленная заявка

### Логика на бэкенде для Speed Cleanup

#### Автоматические задачи (Cron Jobs / Scheduled Tasks)

1. **Проверка одобренных заявок для завершения (каждые 5-10 минут)**
   - Найти все заявки типа `speedCleanup` со статусом `approved`
   - Для каждой заявки проверить: если `updated_at` (время одобрения) + 24 часа < текущее время
   - Если условие выполнено:
     - Изменить статус на `completed`
     - Перевести все донаты (за вычетом комиссии) исполнителю
     - Отправить пуш-уведомление исполнителю о получении донатов (на английском)

#### Обработка одобрения заявки

При одобрении заявки:
1. Изменить статус на `approved`
2. Заявка остается в статусе `approved` для сбора донатов в течение 24 часов
3. Через 24 часа автоматически выполняется завершение (см. выше)

#### Обработка отклонения заявки

При отклонении заявки:
1. Сохранить причину отклонения (как в waste)
2. Изменить статус на `rejected`
3. Если были донаты, вернуть их донатерам
4. Отправить пуш-уведомления об отклонении

---

### Логика на бэкенде для Event

#### Автоматические задачи (Cron Jobs / Scheduled Tasks)

1. **Проверка времени до события (каждые 5-10 минут)**
   - Найти все заявки типа `event` со статусом `inProgress`
   - Для каждой заявки проверить:
     - Если `start_date - 24 часа = текущее время` (с точностью до минуты):
       - Отправить пуш-уведомление всем участникам (из `participants`)
       - Сообщение: "Event starts in 24 hours!" (на английском)
     - Если `start_date - 2 часа = текущее время` (с точностью до минуты):
       - Отправить пуш-уведомление всем участникам
       - Сообщение: "Event starts in 2 hours!" (на английском)
     - Если `start_date = текущее время` (с точностью до минуты):
       - Отправить пуш-уведомление заказчику (`created_by`)
       - Сообщение: "Time to start the event!" (на английском)

2. **Проверка возможности закрытия события (при запросе заявки)**
   - При получении заявки типа `event` со статусом `inProgress` проверить:
     - Если `start_date < текущее время`: заявка может быть закрыта (кнопка активна)
     - Если `start_date >= текущее время`: заявка не может быть закрыта (кнопка неактивна)
   - Вернуть в ответе поле `can_close` (boolean) и `time_until_start` (если еще не началось)

#### Обработка закрытия события

При закрытии события заказчиком:
1. Принять данные:
   - `photos_after` - массив фото после уборки
   - `actual_participants` - массив ID реальных участников
2. Сохранить данные в заявке
3. Изменить статус на `pending`
4. Отправить заявку на модерацию

#### Обработка одобрения заявки

При одобрении заявки:
1. Начислить коины:
   - Заказчику (`created_by`): 1 коин
   - Всем реальным участникам (из `actual_participants`): по 1 коину каждому
   - Всем донатерам (из `donations`): по 1 коину каждому

2. Рассчитать и перевести деньги заказчику:
   - Суммировать: `cost` (от заказчика) + все суммы из `donations`
   - Вычесть комиссию
   - Перевести оставшуюся сумму заказчику

3. Отправить пуш-уведомления (на английском):
   - Заказчику: "Thank you for organizing the event!" (пуш должен открывать страницу заявки)
   - Реальным участникам: "Thank you for participating in the event!" (пуш должен открывать страницу заявки)
   - Донатерам: "Thank you for your donation!" (пуш должен открывать страницу заявки)

4. Изменить статус заявки на `completed`

#### Обработка отклонения заявки

При отклонении заявки:
1. Сохранить причину отклонения (как в waste)
2. Изменить статус на `rejected`
3. Вернуть деньги:
   - Вернуть деньги заказчику (если была платная заявка)
   - Вернуть деньги всем донатерам
4. Отправить пуш-уведомления об отклонении:
   - Заказчику: сообщение из `rejection_reason` или стандартное "Your request was rejected" (пуш должен открывать страницу заявки)
   - Донатерам: "Request you donated to was rejected: {сообщение}" (пуш должен открывать страницу заявки)

---

### Логика на бэкенде для Waste

#### Автоматические задачи (Cron Jobs / Scheduled Tasks)

1. **Проверка напоминаний исполнителю (каждые 5-10 минут)**
   - Найти все заявки со статусом `inProgress` типа `wasteLocation`
   - Для каждой заявки проверить: если `join_date + 22 часа = текущее время` (с точностью до минуты)
   - Если условие выполнено:
     - Отправить пуш-уведомление исполнителю (`joined_user_id`)
     - Сообщение: "You have 2 hours left to complete the request!" (на английском)
     - Пуш должен открывать страницу заявки

2. **Проверка истекших присоединений (каждые 5-10 минут)**
   - Найти все заявки со статусом `inProgress` типа `wasteLocation`
   - Для каждой заявки проверить: если `join_date + 24 часа < текущее время`
   - Если условие выполнено:
     - Отправить пуш-уведомление исполнителю (`joined_user_id`)
     - Сообщение: "You didn't complete the request on time. Please try to be more responsible next time." (на английском)
     - Пуш должен открывать страницу заявки
     - Отправить пуш-уведомление создателю (`created_by`)
     - Сообщение: "The request was not completed on time and is now available for everyone again." (на английском)
     - Пуш должен открывать страницу заявки
     - Изменить статус на `new`
     - Обнулить `joined_user_id` и `join_date`
     - Сохранить изменения

2. **Уведомление о скором удалении неактивных waste заявок (каждые 5-10 минут)**
   - **TODO: После проверки вернуть комментарий "через 7 дней" (сейчас 1 день для тестирования)**
   - Найти все waste заявки со статусом `new`, где `expires_at - 1 день <= текущее время` и `expires_at > текущее время` и `extended_count = 0`
   - Для каждой заявки:
     - Отправить пуш-уведомление создателю: "Your request will be deleted in 24 hours. You can extend it for another week by opening the request."
     - Пуш должен открывать страницу заявки

3. **Удаление неактивных waste заявок (каждые 24 часа)**
   - **TODO: После проверки вернуть комментарий "через 8 дней" (сейчас 2 дня для тестирования: 1 день + 1 день ожидания)**
   - Найти все waste заявки со статусом `new`, где `expires_at <= текущее время`
   - Для каждой заявки:
     - Вернуть деньги создателю (если была платная заявка)
     - Вернуть деньги всем донатерам
     - Отправить пуш-уведомления:
       - Создателю: "Your request was deleted due to inactivity"
       - Донатерам: "Request you donated to was deleted"
     - Удалить заявку из БД

#### Обработка присоединения исполнителя

При присоединении исполнителя к заявке:
1. Сохранить `joined_user_id` и `join_date`
2. Изменить статус на `inProgress`
3. Отправить пуш-уведомление создателю (`created_by`):
   - Сообщение: "Someone joined your request!" (на английском)
   - Пуш должен открывать страницу заявки

#### Обработка отправки на рассмотрение

При отправке заявки на рассмотрение:
1. Изменить статус на `pending`
2. Отправить пуш-уведомление создателю (`created_by`):
   - Сообщение: "Your request has been submitted for review!" (на английском)
   - Пуш должен открывать страницу заявки

#### Обработка одобрения заявки

При одобрении заявки необходимо:

1. Начислить коины:
   - Создателю: 1 коин
   - Исполнителю (`joined_user_id`): 1 коин
   - Всем донатерам: по 1 коину каждому

2. Рассчитать и перевести деньги исполнителю:
   - Суммировать: `cost` (от создателя) + все суммы из `donations`
   - Вычесть комиссию
   - Перевести оставшуюся сумму исполнителю

3. Отправить пуш-уведомления (на английском):
   - Создателю: "Thank you for your initiative!" (пуш должен открывать страницу заявки)
   - Исполнителю: "Thank you for completing the request!" (пуш должен открывать страницу заявки)
   - Донатерам: "Thank you for your donation!" (пуш должен открывать страницу заявки)

4. Изменить статус заявки на `completed`

#### Обработка отклонения заявки

При отклонении заявки необходимо:

1. Сохранить причину отклонения:
   - Если передано кастомное сообщение (`rejection_reason`), сохранить его
   - Если нет, использовать стандартное сообщение: "Request was rejected by moderator"

2. Изменить статус заявки на `rejected`

3. Вернуть деньги:
   - Вернуть деньги создателю (если была платная заявка)
   - Вернуть деньги всем донатерам

4. Отправить пуш-уведомления:
   - Создателю: сообщение из `rejection_reason` или стандартное "Your request was rejected" (пуш должен открывать страницу заявки)
   - Донатерам: "Request you donated to was rejected: {сообщение}" (пуш должен открывать страницу заявки)

---

### Speed Cleanup (speed)

#### Жизненный цикл заявки

1. **Создание заявки (локально)**
   - Пользователь создает заявку для себя
   - Заявка сохраняется только локально в приложении
   - На бэкенд не отправляется

2. **Начало выполнения**
   - Когда пользователь переходит на страницу выполнения заявки
   - Заявка отправляется на бэкенд со статусом `inProgress`
   - Заявка становится видимой для других пользователей

3. **Выполнение работы**
   - Пользователь выполняет работу
   - Загружает фото "до" и "после"
   - Заполняет необходимую информацию

4. **Отправка на рассмотрение**
   - После выполнения пользователь отправляет заявку на рассмотрение
   - Статус меняется на `pending`
   - Заявка передается модератору

5. **Одобрение заявки**
   - Модератор одобряет заявку
   - Статус меняется на `approved`
   - **На бэкенде:**
     - Заявка остается в статусе `approved` в течение **24 часов** для сбора донатов
     - Пользователи могут задонатить заявку
     - Через 24 часа после одобрения:
       - Статус меняется на `completed`
       - Все донаты (за вычетом комиссии) переводятся исполнителю
       - Отправляется пуш-уведомление исполнителю о получении донатов (на английском)

6. **Отклонение заявки**
   - Модератор отклоняет заявку
   - Статус меняется на `rejected`
   - **На бэкенде:**
     - Если были донаты, они возвращаются донатерам
     - Отправляются пуш-уведомления с сообщением об отклонении

**Важно:**
- Все временные проверки (24 часа после одобрения) выполняются на бэкенде
- Пуш-уведомления отправляются только с бэкенда

---

### Event (event)

#### Жизненный цикл заявки

1. **Создание события**
   - Пользователь создает событие с указанием времени начала (`start_date`)
   - Заказчик автоматически становится участником события
   - Статус сразу меняется на `inProgress`
   - Заявка публикуется и становится доступной для присоединения

2. **Присоединение участников и донаты**
   - Множество людей могут присоединиться к событию
   - Множество людей могут задонатить событие
   - Участники сохраняются в `participants`
   - Донатеры сохраняются в `donations`

3. **Автоматические пуш-уведомления (на бэкенде)**
   - **За 24 часа до события:**
     - Отправляется пуш-уведомление всем участникам (из `participants`)
     - Сообщение: "Event starts in 24 hours!" (на английском)
     - Пуш должен открывать страницу заявки
   - **За 2 часа до события:**
     - Отправляется пуш-уведомление всем участникам (из `participants`)
     - Сообщение: "Event starts in 2 hours!" (на английском)
     - Пуш должен открывать страницу заявки
   - **Как только событие началось (`start_date` наступило):**
     - Отправляется пуш-уведомление заказчику (`created_by`)
     - Сообщение: "Time to start the event!" (на английском)
     - Пуш должен открывать страницу заявки

4. **Завершение события**
   - После того как время события прошло (`start_date` прошло)
   - Заказчик видит кнопку "Завершить" (или "Сделано")
   - **До времени события:**
     - Кнопка неактивна (нельзя нажать)
     - Показывается надпись: "До события осталось: {время}"
   - **После времени события:**
     - Кнопка становится активной
     - Надпись меняется на зеленую: "Можно закрыть субботник"

5. **Страница закрытия события**
   - При нажатии на кнопку "Завершить" заказчик переходит на страницу закрытия
   - На странице закрытия:
     - Загрузка фото после уборки (`photos_after` для event)
     - Список всех участников (кроме заказчика) с галочками
     - Заказчик отмечает галочками тех, кто реально участвовал
     - Тех, кто не пришел, не отмечает
   - При нажатии "Сделано" (или "Отправить"):
     - Заявка отправляется на рассмотрение со статусом `pending`
     - Отправляется массив реальных участников (`actual_participants`)

6. **Одобрение заявки**
   - Модератор одобряет заявку
   - Статус меняется на `approved`
   - **На бэкенде:**
     - Начисляются коины:
       - Заказчику: 1 коин
       - Всем реальным участникам (из `actual_participants`): по 1 коину каждому
       - Всем донатерам: по 1 коину каждому
     - Отправляются пуш-уведомления (на английском):
       - Заказчику: "Thank you for organizing the event!" (пуш должен открывать страницу заявки)
       - Реальным участникам: "Thank you for participating in the event!" (пуш должен открывать страницу заявки)
       - Донатерам: "Thank you for your donation!" (пуш должен открывать страницу заявки)
     - Все деньги (заказчика + донатеров), за вычетом комиссии, переводятся заказчику
   - Статус меняется на `completed`

7. **Отклонение заявки**
   - Модератор отклоняет заявку
   - Статус меняется на `rejected`
   - **На бэкенде:**
     - Возвращаются все деньги (заказчику и донатерам)
     - Отправляются пуш-уведомления с сообщением об отклонении

#### Новые поля для Event

1. **`actual_participants`** (array[string], опционально)
   - Массив ID реальных участников события
   - Заполняется заказчиком при закрытии события
   - Используется для начисления коинов только тем, кто реально участвовал

2. **`photos_after`** (array[string], опционально)
   - Фото после уборки для события
   - Загружаются заказчиком на странице закрытия события
   - Уже существует в модели, но нужно использовать для event

#### Автоматические задачи на бэкенде для Event

1. **Проверка времени до события (каждые 5-10 минут)**
   - Найти все заявки типа `event` со статусом `inProgress`
   - Для каждой заявки проверить:
     - Если `start_date - 24 часа = текущее время` (с точностью до минуты):
       - Отправить пуш-уведомление всем участникам (из `participants`)
       - Сообщение: "Event starts in 24 hours!" (на английском)
       - Пуш должен открывать страницу заявки
     - Если `start_date - 2 часа = текущее время` (с точностью до минуты):
       - Отправить пуш-уведомление всем участникам (из `participants`)
       - Сообщение: "Event starts in 2 hours!" (на английском)
       - Пуш должен открывать страницу заявки
     - Если `start_date = текущее время` (с точностью до минуты):
       - Отправить пуш-уведомление заказчику (`created_by`)
       - Сообщение: "Time to start the event!" (на английском)
       - Пуш должен открывать страницу заявки

2. **Проверка возможности закрытия события (при запросе заявки)**
   - Если `start_date < текущее время`: кнопка "Завершить" активна
   - Если `start_date >= текущее время`: кнопка "Завершить" неактивна, показывать время до события

**Важно:**
- Все временные проверки и пуш-уведомления выполняются на бэкенде
- Приложение только отправляет данные и получает статусы
- Сообщения о времени до события не показываются в приложении, все через бэкенд

---

## Изменения в админ-панели

### Страница модерации заявок

На странице модерации (`RequestsManagementPage`) необходимо добавить:

1. **Список заявок со статусом `pending`**
   - Фильтрация по типу заявки (waste, event, speed)
   - Отображение информации о заявке
   - Кнопки "Одобрить" и "Отклонить"

2. **Модальное окно/форма для отклонения**
   - Поле для ввода кастомного сообщения (`rejection_message`)
   - Возможность выбрать стандартное сообщение
   - Кнопка "Отклонить" для подтверждения

3. **Модальное окно для одобрения**
   - Подтверждение одобрения
   - Кнопка "Одобрить" для подтверждения

### Пример UI для модерации

```
┌─────────────────────────────────────┐
│  Request: "Мусор в парке"           │
│  Type: Waste Location               │
│  Status: pending                    │
│  Created by: user@example.com       │
│  Executor: executor@example.com     │
│  Donations: $50 (3 donors)          │
│                                     │
│  [Approve]  [Reject]                │
└─────────────────────────────────────┘
```

При нажатии на "Reject":
```
┌─────────────────────────────────────┐
│  Reject Request                     │
│                                     │
│  Rejection reason:                  │
│  ┌───────────────────────────────┐ │
│  │ [Standard message]            │ │
│  └───────────────────────────────┘ │
│                                     │
│  Or enter custom message:           │
│  ┌───────────────────────────────┐ │
│  │                               │ │
│  │                               │ │
│  └───────────────────────────────┘ │
│                                     │
│  [Cancel]  [Reject Request]        │
└─────────────────────────────────────┘
```

---

## Изменения в приложении (Flutter)

### Обновление модели RequestModel

1. Добавить поддержку новых статусов:
   - `new`
   - `inProgress`

2. Добавить поле `rejectionReason` (или `rejectionMessage`)

3. Обновить метод `statusColor` для новых статусов

4. Обновить методы проверки статусов

### Обновление UI

1. Отображение новых статусов в карточках заявок
2. Обновление логики присоединения к заявкам
3. Отображение сообщения об отклонении при статусе `rejected`

### Изменения для Speed Cleanup

1. **Локальное сохранение заявки**
   - Заявка создается и сохраняется только локально до перехода на страницу выполнения
   - При переходе на страницу выполнения заявка отправляется на бэкенд со статусом `inProgress`

2. **Страница выполнения**
   - После отправки на бэкенд заявка становится видимой для других пользователей
   - Пользователь может выполнить работу и отправить на рассмотрение

### Изменения для Event

1. **Создание события**
   - При создании заказчик автоматически добавляется в `participants`
   - Статус сразу меняется на `inProgress`
   - Заявка публикуется сразу

2. **Страница закрытия события**
   - Доступна только заказчику
   - Кнопка "Завершить" активна только после времени события (`start_date`)
   - До времени события показывается: "До события осталось: {время}" (время получается с бэкенда)
   - После времени события показывается зеленая надпись: "Можно закрыть субботник"
   - На странице закрытия:
     - Загрузка фото после уборки (`photos_after`)
     - Список участников (кроме заказчика) с галочками
     - Отметка реальных участников
     - Кнопка "Сделано" для отправки на рассмотрение

3. **Обновление модели RequestModel**
   - Добавить поле `actualParticipants` (array[string])
   - Использовать существующее поле `photosAfter` для фото после уборки события

---

## Примечания

- **Все пуш-уведомления отправляются только с бэкенда** (на английском языке)
- **Все пуш-уведомления должны открывать соответствующую страницу заявки при нажатии**
- **Все временные проверки выполняются на бэкенде** (24 часа, 7 дней, время до события и т.д.)
- **Приложение только отправляет данные и получает статусы**
- Комиссия рассчитывается на бэкенде
- Автоматические задачи (проверка истекших присоединений, удаление неактивных заявок, проверка времени событий, напоминания) выполняются на бэкенде
- Возврат денег и начисление коинов выполняются на бэкенде
- Перевод денег исполнителю/заказчику выполняется на бэкенде
- Сообщения о времени до события не показываются в приложении, все проверки через бэкенд

---

## TODO

- [ ] Добавить тесты для новой логики
- [ ] Обновить API документацию
- [ ] Обновить документацию для мобильного приложения

